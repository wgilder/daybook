# Puppet Pipelines demo, v6
walter.gildersleeve/daybook:
  Env:
    - DAYBOOK_PORT_DEST: "8080"
    - DBAPI_PROTOCOL: "http"
    - DBAPI_URL: "localhost"
    - DBAPI_PORT: "9000"
  PreBuild:
  Build:
    - docker login -u "$DISTELLI_DOCKER_USERNAME" -p "$DISTELLI_DOCKER_PW" $DISTELLI_DOCKER_ENDPOINT
    - docker build --quiet=false -t "$DISTELLI_DOCKER_REPO" $DISTELLI_DOCKER_PATH
    - docker tag "$DISTELLI_DOCKER_REPO" "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM"
    - docker push "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM"
  PkgInclude:
  PkgExclude:
  PreInstall:
    - sudo docker login -u "$DISTELLI_DOCKER_USERNAME" -p "$DISTELLI_DOCKER_PW" $DISTELLI_DOCKER_ENDPOINT
  PostInstall:
  Exec:
### Docker Exec Commands ###
    - cid=$(uuidgen)
    - trap 'sudo docker stop $cid' SIGTERM
    - echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - echo ~~~ sudo -E docker run --name=$cid --env DAYBOOK_API_PROTOCOL=$DBAPI_PROTOCOL --env DAYBOOK_API_URL=$DBAPI_URL --env DAYBOOK_API_PORT=$DBAPI_PORT -p $DAYBOOK_PORT_DEST:80 $DISTELLI_DOCKER_ENVS --rm=true $DISTELLI_DOCKER_PORTS "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM" &
    - echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    - sudo -E docker run --name=$cid --env DAYBOOK_BUILD=$DISTELLI_BUILDNUM --env DAYBOOK_API_PROTOCOL=$DBAPI_PROTOCOL --env DAYBOOK_API_URL=$DBAPI_URL --env DAYBOOK_API_PORT=$DBAPI_PORT -p $DAYBOOK_PORT_DEST:80 $DISTELLI_DOCKER_ENVS --rm=true $DISTELLI_DOCKER_PORTS "$DISTELLI_DOCKER_REPO:$DISTELLI_BUILDNUM" &
    - wait
    - "true"
### End Docker Exec Commands ###
